# 三次握手与四次挥手

*创建于：2019-05-06；更新于：2019-05-06*

本文由其它文章节选优化，具体请查看参考；

## TCP报文首部格式

![原型图](./img/tcp.jpg)

部分说明：
- SYN：同步标志位，用来请求建立连接;
- ACK: 确认标志位，用来表示确定，做出应答；
- FIN：完成标志位，表示发送端已经达到数据末尾，将释放一个连接;
- 序号seq（Sequence Number）：其实也就是初始序列号(ISN),用来标识从TCP发端向TCP收端发送的数据字节流;
- 确认号ack（Acknowledgment Number）：确认序列号包含发送确认的一端所期望收到的下一个序号，因此，确认序号应当是上次已成功收到数据字节序号加1;

## 三次握手

![三次握手](./img/link.jpg)

刚开始的时候，服务器和客户端都为CLOSED状态。在通信开始前，双方都得创建各自的传输控制块（TCB）。

服务器创建完TCB后遍进入LISTEN(监听)状态，此时准备接收客户端发来的连接请求。

### 第一次握手

客户端向服务端发送连接请求报文段。该报文段的头部中同步SYN=1，确认ACK=0，同时选择一个初始序号seq=x(ISN)。请求发送后，客户端便进入SYN-SENT(同步已发送)状态。

- SYN=1，ACK=0表示该报文段为连接请求报文
- x为本次TCP通信的字节流的初始序号(ISN)
- TCP规定：SYN=1的报文段不能有数据部分，但要消耗掉一个序号

### 第二次握手

服务端收到连接请求报文段后，如果同意连接，会发送一个应答：SYN=1，ACK=1，seq=y，ack=x+1。发送完应答后服务端进入SYN-RCVD(同步接收)状态。

- SYN=1，ACK=1表示该报文段为连接同意的应答报文
- seq=y(ISN)表示服务端作为发送者时，发送字节流中的第一个字节序号
- ack=x+1表示服务端希望客户端发送的下一个数据报初始序号是从x+1开始
- 这个报文也不能携带数据，但是同样要消耗一个序号

### 第三次握手

客户端收到服务端连接同意的应答后，还会向服务端发送一个确认报文段，表示：服务端发来的连接同意应答已经成功收到。该报文段的头部为：ACK=1，seq=x+1，ack=y+1。
客户端发完这个报文段后便进入ESTABLISHED(已建立连接)状态，服务端收到这个应答后也进入ESTABLISHED状态，此时连接的建立完成！

- 这个报文段可以携带数据

![三次握手](./img/link.gif)

### 三次握手的作用

- 确认双方的接受能力、发送能力是否正常。
- 指定自己的初始化序列号，为后面的可靠传送做准备。
- 如果是 https 协议的话，三次握手这个过程，还会进行数字证书的验证以及加密密钥的生成到。

### 注意

- ISN不是固定的
- 服务器第一次收到客户端的 SYN 之后，就会处于 SYN_RCVD 状态，此时双方还没有完全建立其连接，服务器会把此种状态下请求连接放在一个队列里，我们把这种队列称之为半连接队列。当然还有一个全连接队列，就是已经完成三次握手，建立起连接的就会放在全连接队列中。如果队列满了就有可能会出现丢包现象。
- 需要三次握手，避免网络等因素，造成重复建立连接；

## 四次挥手

![四次挥手](./img/fin.jpg)

数据传输完毕后，双方都可释放连接。最开始的时候，客户端和服务器都是处于ESTABLISHED状态，然后客户端主动关闭，服务器被动关闭。

### 第一次挥手

客户端数据发送完成，则它向服务端发送连接释放请求。该请求只有报文头，头中携带的主要参数为：FIN=1，seq=u。此时，客户端将进入FIN-WAIT-1（终止等待1）状态。TCP规定，FIN报文段即使不携带数据，也要消耗一个序号。

- FIN=1表示该报文段是一个连接释放请求
- seq=u，u-1是客户端向服务端发送的最后一个字节的序号

### 第二次挥手

服务器收到客户端连接释放报文，通知相应的高层应用进程，告诉它客户端向服务器这个方向的连接已经释放了。
此时服务端进入了CLOSE-WAIT（关闭等待）状态，并向客户端发出连接释放的应答，其报文头包含：ACK=1，ack=u+1，并且带上自己的序列号seq=v。

- ACK=1：除TCP连接请求报文段以外，TCP通信过程中所有数据报的ACK都为1，表示应答
- seq=v，v是服务端释放应答报文段第一个字节序号
- ack=u+1表示希望收到从第u+1个字节开始的报文段，并且已经成功接收了前u个字节

客户端收到该应答后，进入FIN-WAIT-2（终止等待2）状态，等待服务器发送连接释放报文（在这之前还需要接受服务器发送的最后的数据）。
第二次挥手完成后，客户端到服务端方向的连接已经释放，服务端不会再接收客户端的数据，客户端也没有数据要发送了。但服务端到客户端方向的连接仍然存在，服务器若发送数据，客户端依然要接受。这个状态还要持续一段时间，也就是整个CLOSE-WAIT(关闭等待)状态持续的时间。

### 第三次挥手

服务端将最后的数据发送完毕后，就向客户端发送连接释放报文，其报文头包含：FIN=1，ack=u+1，由于在CLOS-WAIT（关闭等待）状态，服务端很可能又发送了一些数据，假定此时的序列号为seq=w，此时，服务器就进入了LAST-ACK（最后确认）状态，等待客户端的确认。

### 第四次挥手

客户端收到服务器的连接释放报文后，向服务端发出确认应答，报文头：ACK=1，ack=w+1，而自己的序列号是seq=u+1，此时，客户端就进入了TIME-WAIT（时间等待）状态。
该状态会持续2MSL（最长报文段寿命）时间，这个期间TCP连接还未释放，若该时间段内没有服务端的重发请求的话，客户端就进入CLOSED状态，撤销TCB。
服务端只要收到了客户端发出的确认，立即进入CLOSED状态。同样，撤销TCB后，就结束了这次的TCP连接。可以看到，服务器结束TCP连接的时间要比客户端早一些。

![四次挥手](./img/fin.gif)

### 注意

- 需要四次挥手，是因为第二次和第三次挥手需要分开发送；


## 参考

- [关于三次握手与四次挥手面试官想考我们什么？](https://juejin.im/post/5ccd0dfc6fb9a0324a08bb73)
- [TCP的三次握手与四次挥手（详解+动图）](https://blog.csdn.net/qzcsu/article/details/72861891)
- [Tcp--三次握手，四次挥手](https://www.jianshu.com/p/afdd3736c923)
